version: '3'

tasks:
  proto:
    desc: Generate proto code
    cmds:
      - task: proto:{{OS}}
      - >-
        protoc --proto_path=proto
        --go_out=pb --go_opt=paths=source_relative
        --go-grpc_out=pb --go-grpc_opt=paths=source_relative
        --grpc-gateway_out=pb --grpc-gateway_opt=paths=source_relative
        --openapiv2_out=docs/swagger --openapiv2_opt=allow_merge=true,merge_file_name=tlz
        "proto/*.proto"

  proto:windows:
    desc: Generate proto code for Windows
    cmds:
      - cmd: powershell rm "pb/*.go"
      - cmd: powershell rm "docs/swagger/*.json"

  proto:darwin:
    desc: Generate proto code for MacOS
    cmds:
      - cmd: rm -f pb/*.go
      - cmd: rm -f docs/swagger/*.json

  mock:
    desc: Generate mocks
    cmds:
      - cmd: mockgen -package mockdb -destination db/mock/store.go github.com/zcubbs/tlz/db/sqlc Store
      - cmd: mockgen -package mockdb -destination worker/mock/distributor.go github.com/zcubbs/tlz/worker TaskDistributor

  sqlc:
    desc: Generate SQLC code
    cmds:
      - task: sqlc-{{OS}}

  sqlc-windows:
    desc: Generate SQLC code for Windows
    cmds:
      - cmd: docker run --rm -v "${PWD}:/src" -w /src kjconroy/sqlc generate
#      - cmd: sqlc generate

  sqlc-darwin:
    desc: Generate SQLC code for MacOS
    cmds:
      - cmd: sqlc generate

  sqlc-linux:
    desc: Generate SQLC code for Linux
    cmds:
      - cmd: sqlc generate

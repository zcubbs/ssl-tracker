version: '3'

tasks:

  lint:
    desc: Run linter
    deps: [ create-dummy-dist ]
    cmds:
      - golangci-lint run ./... -v

  test:
    desc: Run tests
    deps: [ create-dummy-dist ]
    cmds:
      - go test -cover ./...

  scan:
    desc: Run security scanner
    deps: [ create-dummy-dist ]
    cmds:
      - gosec -conf .gosec.config.json "./..."

  run:
    desc: Start the application with all dependencies
    cmds:
      - go run main.go

  preview:
    desc: Start the application with all dependencies
    cmds:
      - task: :build_tasks:build
      - ./bin/app

  createdb:
    desc: Create database
    cmds:
      - docker exec -it tlz-postgres createdb --username=postgres --owner=postgres tlz

  dropdb:
    desc: Drop database
    cmds:
      - docker exec -it tlz-postgres dropdb --username=postgres tlz

  migrate:
    desc: Run database migration
    cmds:
      - migrate -path db/migrations -database "{{.TEST_DB_URL}}" -verbose up

  migrate:down:
    desc: Rollback database migration
    cmds:
      - migrate -path db/migrations -database "{{.TEST_DB_URL}}" -verbose down

  migrate:new:
    desc: "Generate migration. Usage: task migrate:new -- <migration_name>"
    cmds:
      - cmd: migrate create -ext sql -dir db/migrations -seq {{.CLI_ARGS}}

  network:
    desc: Create Docker network
    cmds:
      - docker network create tlz

  # create file under path web/dist/index.html
  create-dummy-dist:
    desc: Create dummy dist file
    cmds:
      - task: create-dummy-dist:{{OS}}

  create-dummy-dist:linux:
    desc: Create dummy dist file for Linux
    cmds:
      - mkdir -p web/dist
      - touch web/dist/index.html

  create-dummy-dist:darwin:
    desc: Create dummy dist file for Darwin
    cmds:
      - task: create-dummy-dist:linux

  create-dummy-dist:windows:
    desc: Create dummy dist file for Windows
    cmds:
      - cmd: powershell New-Item -Path '.\web\dist\empty.txt' -ItemType File -Force


  evans:
    desc: Run Evans CLI
    cmds:
      - evans --host localhost --port 9000 -r repl
